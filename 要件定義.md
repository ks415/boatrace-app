# ボートレースの特定選手に特化したアプリケーション

本ドキュメントは、特定選手にフォーカスしたボートレース分析・閲覧アプリケーションの要件定義を記載する。現状のプロトタイプ（FastAPI + React + bvp-scraper-python）を基盤に、選手中心の機能へ発展させる。

## 0. 目的・スコープ

- 目的: ユーザーが特定のボートレーサーの過去成績・特徴・出走予定を素早く把握し、当日の意思決定（観戦/投票）を支援する。
- スコープ: Web アプリ（SPA）として提供。将来的にモバイル PWA を想定。
- アウトスコープ:
  - オンライン投票機能の実装（連携リンクは検討）
  - 有料課金/サブスクの決済処理（将来検討）
  - 広告表示や収益化（個人利用を想定のため当面不要）

1.  ユーザー要件（機能一覧）
    このセクションでは、アプリケーションが提供すべき具体的な機能を、ユーザーの視点から整理します。 - 選手検索・選択: - 選手名や登録番号で検索できる機能が必要です。 - 検索結果から選手を選択し、その選手のページに遷移できる必要があります。 - お気に入り選手として登録し、次回以降すぐにアクセスできる機能も検討します。 - 過去の成績閲覧: - 選択した選手の過去のレース成績を、年別・場別・コース別に絞り込んで表示する機能が必要です。 - 表示項目には、着順、タイム、決まり手、配当などの詳細情報を含めるべきです。 - 過去の成績をグラフや統計データ（例：コース別勝率、2 連対率など）で視覚的に表示することで、選手の特徴をより深く理解できるようにします。 - 出走予定表示: - 選択した選手の今後の出走予定を一覧で表示します。 - 開催日、開催場、レース名、レース番号などの情報が必要です。 - 出走予定のレースが近づいたら通知する機能もユーザーエクスペリエンスを高めます。 - 当日参加レースの詳細情報: - 当日、選手が出走するレースがある場合、そのレースの出走表、直前情報、オッズ、結果をリアルタイムまたはそれに近い形で表示します。 - 出走表: 選手名、級別、勝率、モーター番号、ボート番号、展示タイムなどの情報を含めます。 - 直前情報: 展示航走の結果や気象情報、スタート展示の隊形などを表示します。 - オッズ: 1 着、2 連単、3 連単などのオッズをリアルタイムで更新し表示します。 - レース結果: レース終了後、着順、タイム、配当などの結果情報を表示します。 - 選手関連ニュースの表示: - 選択した選手に関するニュース記事や SNS の投稿などを集約して表示する機能が必要です。 - 情報源としては、公式ニュースサイトやスポーツ新聞のウェブサイト、選手の SNS アカウントなどが考えられます。

2.  システム要件（技術スタックとデータ取得）
    次に、これらの機能を実現するための技術的なアプローチと要件を整理します。

        **技術スタック**
        - フロントエンド: ユーザーインターフェースを構築する部分です。モバイルアプリとして開発する場合、React NativeやFlutterがクロスプラットフォーム開発に適しています。Webアプリケーションとして開発する場合は、React、Vue.js、Svelteなどが選択肢になります。
        - バックエンド: データの取得、加工、管理を担当します。Node.js（Express）、Python（Django/Flask）、Goなどが適しています。
        - データベース: 選手情報や過去の成績を保存するために必要です。リアルタイム性が求められるデータにはRedisやMemcachedのようなインメモリデータベースをキャッシュとして利用することも有効です。長期的なデータ保存にはPostgreSQLやMySQLが適しています。

            **データ取得戦略**
            - bvp-scraper-python: ボートレースの公式サイトから出走表、直前情報、オッズ、結果をスクレイピングして取得できる Python ライブラリ

## 3. ペルソナ

- ペルソナ A: 既存ファン/ライト層（週末に観戦・少額投票）
  - ゴール: 推し選手の調子/特徴/当日情報を素早く把握
  - デバイス: スマホ中心
- ペルソナ B: データ志向ファン（頻度高め）
  - ゴール: コース別・場別の傾向を俯瞰、勝率/連対率を元に狙い目を判断
  - デバイス: PC/タブレット

## 4. ユーザーストーリー（抜粋）

- US-01: ユーザーとして、選手名または登録番号で検索し、該当選手のプロフィールページに遷移したい。
- US-02: ユーザーとして、選手の過去成績を年/場/コースでフィルタし、着順・タイム・決まり手・配当を確認したい。
- US-03: ユーザーとして、選手の今後の出走予定を一覧し、開始前に通知を受け取りたい。
- US-04: ユーザーとして、当日出走のレースについて、出走表・直前情報・オッズをまとめて確認したい。
- US-05: ユーザーとして、選手をお気に入り登録し、次回以降ワンタップで詳細にアクセスしたい。

## 5. 機能詳細（MoSCoW + 受け入れ条件）

- Must
  - 検索（名前/登録番号）
    - AC: 部分一致で上位 20 件まで返却、選択で選手詳細へ遷移
  - 選手詳細（プロフィール + 直近成績サマリ）
    - AC: 名前、登録番号、級別、年齢、支部、直近 3 ヶ月集計（勝率、2 連対率、平均 ST）表示
  - 過去成績フィルタ表示（年/場/コース）
    - AC: 範囲指定と複合条件が可能、ページネーション対応
  - 当日レース情報（該当時）
    - AC: 出走表・直前情報・オッズ・結果の参照リンク/埋め込み表示
- Should
  - 統計グラフ（コース別勝率、月別推移、決まり手分布）
  - お気に入り登録/一覧
- Could
  - 出走予定通知（Web Push）
  - ニュース/SNS 集約
- Won’t (for now)
  - ベットシミュレーション/自動予想

技術選択（可視化）:

- フロントエンドのグラフは Recharts を採用（React 親和性と開発速度を重視）

## 6. API 仕様（ドラフト）

既存の API に加え、選手中心の API を追加する。全て JSON、認証は当面不要（内部/ローカル向け）。

既存:

- GET `/api/programs/{race_date}/{stadium_number}/{race_number}`
- GET `/api/odds/{race_date}/{stadium_number}/{race_number}`
- GET `/api/previews/{race_date}/{stadium_number}/{race_number}`
- GET `/api/results/{race_date}/{stadium_number}/{race_number}`
- GET `/api/stadiums/{race_date}`

新規ドラフト:

- GET `/api/racers/search?q={keyword}&number={racer_number}`
  - Res: `[{racer_number, racer_name, class, branch, age}]`
- GET `/api/racers/{racer_number}`
  - Res: `{profile: {...}, recent_summary: {win_rate, top2_rate, avg_st, favorite_course}}`
- GET `/api/racers/{racer_number}/results?from=YYYY-MM-DD&to=YYYY-MM-DD&course=1..6&stadium=1..24&page=1&page_size=50`
  - Res: `{items: [...], page, page_size, total}`（各 item に着順/タイム/決まり手/配当/レースメタ）
- GET `/api/racers/{racer_number}/upcoming?from=YYYY-MM-DD&to=YYYY-MM-DD`
  - Res: `[{race_date, stadium_number, race_number, title}]`
- GET `/api/racers/{racer_number}/stats?range=3m|6m|1y`
  - Res: `{by_course: {...}, by_stadium: {...}, technique_dist: {...}, trend_monthly: [...]}`
  - 既定値: `range=1y`

注: 実装は bvp-scraper-python の提供データに合わせ、足りないデータは蓄積 DB で補完する。

## 7. データモデル（文章 ER）

- Racer（選手）: `racer_number(PK)`, `name`, `class`, `age`, `branch`, `birthplace`, `height`, `weight`, `profile_updated_at`
- Race（レースメタ）: `id(PK)`, `race_date`, `stadium_number`, `race_number`, `title`, `grade`, `distance`
- Result（成績）: `id(PK)`, `racer_number(FK)`, `race_id(FK)`, `course`, `position`, `time`, `technique`, `odds_return`
- Upcoming（出走予定）: `id(PK)`, `racer_number(FK)`, `race_date`, `stadium_number`, `race_number`, `title`
- Favorite（お気に入り）: `id(PK)`, `user_id(FK)`, `racer_number(FK)`, `created_at`
- User（簡易）: `id(PK)`, `auth_provider`, `display_name`

索引:

- `Result(racer_number, race_date)`、`Result(racer_number, course)`に複合 Index

データ保持ポリシー（初期方針）:

- 過去成績(Result)・出走予定(Upcoming)は直近 5 年分を保持対象とする

## 8. 非機能要件

- パフォーマンス: 検索応答 < 500ms（p95、キャッシュ前提）、集計 API < 1s
- 可用性: 開発段階は Best Effort、将来 99.5%
- セキュリティ: 適切な CORS、Rate Limit（将来）、依存脆弱性スキャン
- 監視/ログ: サーバーログ、集計時間のメトリクス化（将来）
- スケーラビリティ: 書き込みは低頻度、読み取りの水平スケールを重視
- 対応プラットフォーム: Chrome（最新）と iOS Safari（iOS 16+）を最低サポート
- 通知: Web Push（ブラウザ通知）。現時点の優先度は低

## 9. 運用・監視

- 定期ジョブ: 前日結果の取り込み、当日朝の出走予定同期
- キャッシュ: 直近アクセスの多い選手/レースをメモリ/Redis でキャッシュ
- バックフィル: 過去データの段階的収集（対象は直近 5 年）

## 10. セキュリティ・法的考慮

- スクレイピングのサイトポリシー遵守、リクエスト頻度の抑制
- 個人情報の最小化（ユーザー登録は任意/将来）
- ログには個人特定情報を残さない
- 認証/認可（段階的導入）:
- 初期: 認証なし。お気に入り等はブラウザ LocalStorage で保持
- 将来: 簡易 Auth（Google/Apple）を導入し、サーバー側にお気に入り等を同期

## 11. リスクと対策

- 公式サイトの構造変更 → スクレイパーの監視と早期修正、抽象化レイヤー導入
- データ欠損/不整合 → スキーマで NULL 許容、推定/再取得の仕組み
- パフォーマンス低下 → キャッシュ/バッチ集計/適切な索引

## 12. マイルストーン（ドラフト）

- M1: 選手検索 API/画面（基本）
- M2: 選手詳細（プロフィール+直近サマリ）
- M3: 過去成績フィルタ + ページング
- M4: 統計グラフ（コース別勝率/推移）
- M5: 出走予定 + 通知（β）

## 13. 決定事項（ヒアリング結果）

- 対応プラットフォーム: Chrome と iOS に対応していれば十分（最小）
- 認証/お気に入り: 初期は匿名（LocalStorage）。将来 Google/Apple で簡易 Auth
- 通知: Web Push を使用。優先度は低
- データ保存: 過去成績は直近 5 年を保存対象
- 統計の既定期間: 1 年をデフォルト
- グラフライブラリ: Recharts を採用
- ニュース/SNS: 初期はモックデータで対応
- 収益化: 不要（広告/課金は実施しない）

## 14. 未決事項 / ヒアリング項目

- 現時点で重大な未決事項はありません。実装過程での論点は本節に随時追記します。
